<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DND Full Online</title>
<link rel="stylesheet" href="frontend/crt.css">
</head>
<body>

<!-- TERMINAL -->
<div id="terminal-container">
    <div id="cmd-container">
        <div id="terminal-wrapper">
            <div id="terminal"></div>
        </div>
        <input id="cli-input" placeholder=">">
    </div>
</div>

<!-- LANDING PAGE -->
<div id="controls">
    <input id="gameId" placeholder="Enter game ID">
    <button id="hostBtn">Host Game</button>
    <button id="joinBtn">Join Game</button>
</div>

<script type="module">
import { logTerminal, clearTerminal, showHelp } from "frontend/cli_helper.js";

const termContainer = document.getElementById("terminal-container");
const term = document.getElementById("terminal");
const controls = document.getElementById("controls");
const wrapper = document.getElementById("terminal-wrapper");
const cmdInput = document.getElementById("cli-input");

function log(msg, options={}) { logTerminal(term, msg, options); }

// ===== FETCH ASCII =====
async function getASCII() {
    try {
        const resp = await fetch("frontend/ascii.txt");
        if (!resp.ok) throw new Error("ASCII file not found");
        return await resp.text();
    } catch (err) {
        log("Failed to load ASCII: " + err);
        return "";
    }
}

// ===== LOCKED FULLSCREEN CRT MODE =====
async function enterTerminalMode() {
    controls.style.display = "none";
    termContainer.style.display = "flex";

    // Lock scrolling
    document.body.style.overflow = "hidden";

    // Prevent text selection
    document.body.style.userSelect = "none";

    // Request fullscreen
    if (!document.fullscreenElement) {
        try { await document.documentElement.requestFullscreen(); } catch {}
    }

    // Auto-focus CLI input
    cmdInput.focus();
}

// ===== PYODIDE =====
let pyodideReady = false;
async function initPyodide() {
    log("Loading Pyodide...");
    window.pyodide = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"});
    pyodideReady = true;

    await pyodide.runPythonAsync(`
import sys
sys.path.insert(0,"dnd_engine")
import engine
`);
    log("Engine loaded.\n");
}

const pyScript = document.createElement("script");
pyScript.src = "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js";
pyScript.onload = initPyodide;
document.body.appendChild(pyScript);

// ===== WEBRTC =====
let pc, dataChannel;

// ===== CRT-STYLE PRINTING =====
async function printLines(lines, options={}) {
    for (const line of lines) {
        log(line, options);
        await new Promise(r => setTimeout(r, Math.random() * 50 + 10));
    }
    scaleASCII();
}

// ===== SCALE ASCII PROPORTIONALLY + VERTICAL CENTER =====
function scaleASCII() {
    const asciiText = term.textContent.split("\n");
    const originalWidth = 145;
    const originalHeight = asciiText.length;

    function applyScale() {
        const vw = window.innerWidth - 40;
        const vh = window.innerHeight - 120; // input + padding
        const fontWidth = 0.6;
        const fontHeight = 1;

        const scaleX = vw / (originalWidth * fontWidth * 16);
        const scaleY = vh / (originalHeight * fontHeight * 16);
        const scale = Math.min(scaleX, scaleY);

        wrapper.style.transform = `scale(${scale})`;

        // vertical centering
        const wrapperHeight = originalHeight * 16 * scale;
        const containerHeight = window.innerHeight - 40;
        const topMargin = Math.max((containerHeight - wrapperHeight - 40)/2, 0);
        wrapper.style.marginTop = topMargin + "px";
    }

    window.addEventListener("resize", applyScale);
    applyScale();
}

// ===== HOST GAME =====
async function startHost() {
    await enterTerminalMode();
    clearTerminal(term);

    log("Booting WebRTC host...");

    const ascii = await getASCII();
    if (ascii) await printLines(ascii.split("\n"), {highlight:true});

    pc = new RTCPeerConnection();
    dataChannel = pc.createDataChannel("dnd");
    dataChannel.onmessage = e => log("[CLIENT] " + e.data);

    pc.onicecandidate = e => {
        if (e.candidate) log("ICE Candidate: " + JSON.stringify(e.candidate));
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const encoded = btoa(JSON.stringify(offer));
    log("Host ready.");
    await printLines(["=== BASE64 GAME ID ===", encoded, "====================="], {highlight:true});

    showHelp(term, true);
}

// ===== JOIN GAME =====
async function joinGame() {
    await enterTerminalMode();
    clearTerminal(term);

    const gameId = document.getElementById("gameId").value.trim();
    if (!gameId) return log("Enter a game ID first!");

    log("Connecting to host...");

    const ascii = await getASCII();
    if (ascii) await printLines(ascii.split("\n"), {highlight:true});

    const offer = JSON.parse(atob(gameId));
    pc = new RTCPeerConnection();

    pc.ondatachannel = ev => {
        dataChannel = ev.channel;
        dataChannel.onmessage = e => log("[HOST] " + e.data);
    };

    pc.onicecandidate = e => {
        if (e.candidate) log("ICE Candidate: " + JSON.stringify(e.candidate));
    };

    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    log("Connected to host.");
    showHelp(term, false);
}

// ===== BUTTONS =====
document.getElementById("hostBtn").onclick = async () => {
    if (!pyodideReady) return log("Engine not ready.");
    startHost();
};

document.getElementById("joinBtn").onclick = async () => {
    if (!pyodideReady) return log("Engine not ready.");
    joinGame();
};

// ===== CLI INPUT =====
cmdInput.addEventListener("keydown", async e => {
    if (e.key !== "Enter") return;
    const cmd = cmdInput.value.trim();
    cmdInput.value = "";

    log("> " + cmd);

    if (pyodideReady) {
        try {
            const res = await pyodide.runPythonAsync(cmd);
            if (res !== undefined) log(String(res));
        } catch (err) {
            log("Error: " + err);
        }
    }

    if (dataChannel?.readyState === "open") dataChannel.send(cmd);
});

// Always focus input on click anywhere
termContainer.addEventListener("click", () => cmdInput.focus());

// Prevent text selection and dragging
termContainer.addEventListener("mousedown", e => e.preventDefault());
</script>
</body>
</html>
