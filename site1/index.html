<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>D&D Terminal</title>
<link rel="stylesheet" href="frontend/crt.css">
</head>
<body>

<div id="terminal-container">
    <pre id="terminal"></pre>
</div>

<div id="controls">
    <input id="gameId" placeholder="Enter Game ID">
    <button id="hostBtn">Host Game</button>
    <button id="joinBtn">Join Game</button>
</div>

<script type="module">
// ===== HELPERS =====
import { logTerminal, clearTerminal, showHelp } from "frontend/cli_helper.js";

const termContainer = document.getElementById("terminal-container");
const term = document.getElementById("terminal");
function log(msg, options={}) { logTerminal(term,msg,options); }
function clear() { clearTerminal(term); }

// ===== PYODIDE =====
let pyodideReady=false;
async function initPyodide(){
    log("Loading Pyodide...");
    window.pyodide = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"});
    pyodideReady=true;
    log("Pyodide ready.");

    await pyodide.runPythonAsync(`
import sys
sys.path.insert(0,"/dnd_engine")
import engine
all_chars = {}
combat = None
dm = None
    `);
    log("Engine loaded.\n");

    // Load ASCII art
    const ascii = await (await fetch("frontend/ascii.txt")).text();
    log(ascii,{highlight:true});
}

// Load Pyodide dynamically
const pyScript = document.createElement("script");
pyScript.src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js";
pyScript.onload=initPyodide;
document.body.appendChild(pyScript);

// ===== WEBRTC =====
let pc, dataChannel, isHost=false;
let AUTO_TURN_INTERVAL = 15;
let autoTurnTimer;

function startAutoTurns(){
    if(!isHost) return;
    if(autoTurnTimer) clearInterval(autoTurnTimer);
    autoTurnTimer = setInterval(async ()=>{
        if(!pyodideReady) return;
        try{
            const next = await pyodide.runPythonAsync(`
if combat and combat.turn_order:
    combat.turn_order.append(combat.turn_order.pop(0))
    combat.turn_order[0]
else: None
            `);
            if(next) log("Next turn: "+next,{highlight:true});
            if(dataChannel?.readyState==="open") dataChannel.send(`/next_turn ${next}`);
        } catch(err){ log("Error advancing turn: "+err); }
    }, AUTO_TURN_INTERVAL*1000);
}

// ===== HOST GAME =====
document.getElementById("hostBtn").onclick=async()=>{
    if(!pyodideReady) return log("Pyodide not ready");
    isHost=true;
    termContainer.style.display="block";
    clear();
    log("Hosting game...",{highlight:true});

    pc = new RTCPeerConnection();
    dataChannel = pc.createDataChannel("dnd");
    dataChannel.onmessage = e => handleMessage(e.data);
    pc.onicecandidate = e => { if(e.candidate) log("ICE Candidate: "+JSON.stringify(e.candidate)); };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    log("=== HOST GAME ID (Base64) ===",{highlight:true});
    log(btoa(JSON.stringify(offer)),{highlight:true});
    log("============================",{highlight:true});

    showHelp(term,true);
    startAutoTurns();
};

// ===== JOIN GAME =====
document.getElementById("joinBtn").onclick=async()=>{
    if(!pyodideReady) return log("Pyodide not ready");
    const gameId = document.getElementById("gameId").value.trim();
    if(!gameId) return log("Enter Game ID!");
    termContainer.style.display="block";
    clear();
    log("Joining game...",{highlight:true});

    const offer = JSON.parse(atob(gameId));
    pc = new RTCPeerConnection();
    pc.ondatachannel = ev => {
        dataChannel = ev.channel;
        dataChannel.onmessage = e => handleMessage(e.data);
    };
    pc.onicecandidate = e => { if(e.candidate) log("ICE Candidate: "+JSON.stringify(e.candidate)); };

    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    log("=== JOINED GAME ===",{highlight:true});
    showHelp(term,false);
};

// ===== CLI INPUT =====
const cmdInput = document.createElement("input");
cmdInput.placeholder="Type command...";
cmdInput.style.width="100%";
termContainer.appendChild(cmdInput);
cmdInput.addEventListener("keydown", async(e)=>{
    if(e.key!=="Enter") return;
    const cmd = e.target.value.trim();
    e.target.value="";
    log("> "+cmd);
    await handleCommand(cmd);
});
termContainer.addEventListener("click",()=>cmdInput.focus());

async function handleCommand(cmd){
    if(!pyodideReady) return log("Pyodide not ready");
    if(cmd.startsWith("/help")){
        showHelp(term,isHost);
        return;
    }
    if(cmd.startsWith("/tut")){
        if(isHost){
            log("DM Tutorial: You can control turns, HP, conditions, etc.",{dm:true});
            if(dataChannel?.readyState==="open") dataChannel.send("PLAYER TUTORIAL: Use /roll, /attack, /cast_spell, /list");
        }
        return;
    }
    if(cmd.startsWith("/roll") || cmd.startsWith("/attack") || cmd.startsWith("/cast_spell") || cmd.startsWith("/list") || cmd.startsWith("/next_turn")){
        if(isHost){
            try{
                const res = await pyodide.runPythonAsync(cmd.replace("/",""));
                log(String(res));
                if(dataChannel?.readyState==="open") dataChannel.send(cmd);
            }catch(err){ log("Python Error: "+err); }
        } else {
            if(dataChannel?.readyState==="open") dataChannel.send(cmd);
        }
        return;
    }
    if(cmd.startsWith("/create_char")){
        try{
            const jsonStr = cmd.slice(12).trim();
            await pyodide.runPythonAsync(`import base64
import json
cdata = json.loads('${jsonStr}')
all_chars[cdata["name"]] = engine.Character(cdata["name"],cdata["race"],list(cdata["classes"].keys())[0])
            `);
            log("Character created.",{highlight:true});
            if(dataChannel?.readyState==="open") dataChannel.send(cmd);
        } catch(err){ log("Error creating char: "+err); }
        return;
    }
    log("Unknown command.");
}

// ===== HANDLE INCOMING MESSAGES =====
function handleMessage(msg){
    if(msg.startsWith("/next_turn")){
        log(msg.replace("/next_turn ",""),{highlight:true});
    } else {
        log(msg);
    }
}
</script>
</body>
</html>
