<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DND Full Online</title>
<link rel="stylesheet" href="frontend/crt.css">
</head>
<body>

<!-- TERMINAL -->
<div id="terminal-container">
    <div id="terminal"></div>
</div>

<!-- LANDING PAGE -->
<div id="controls">
    <input id="gameId" placeholder="Enter game ID">
    <button id="hostBtn">Host Game</button>
    <button id="joinBtn">Join Game</button>
</div>

<script type="module">
import { logTerminal, clearTerminal, showHelp } from "frontend/cli_helper.js";

const termContainer = document.getElementById("terminal-container");
const term = document.getElementById("terminal");
const controls = document.getElementById("controls");

function log(msg, options={}) { logTerminal(term, msg, options); }

// ===== FETCH ASCII =====
async function getASCII() {
    try {
        const resp = await fetch("frontend/ascii.txt");
        if (!resp.ok) throw new Error("ASCII file not found");
        return await resp.text();
    } catch (err) {
        log("Failed to load ASCII: " + err);
        return "";
    }
}

// ===== FULLSCREEN =====
async function lockFullscreen() {
    if (!document.fullscreenElement) {
        try { await document.documentElement.requestFullscreen(); } catch {}
    }
}

// ===== ENTER TERMINAL MODE =====
async function enterTerminalMode() {
    controls.style.display = "none";
    termContainer.style.display = "flex";
    await lockFullscreen();
    cmdInput.focus();
}

// ===== PYODIDE =====
let pyodideReady = false;
async function initPyodide() {
    log("Loading Pyodide...");
    window.pyodide = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"});
    pyodideReady = true;

    await pyodide.runPythonAsync(`
import sys
sys.path.insert(0,"dnd_engine")
import engine
`);
    log("Engine loaded.\n");
}

const pyScript = document.createElement("script");
pyScript.src = "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js";
pyScript.onload = initPyodide;
document.body.appendChild(pyScript);

// ===== WEBRTC =====
let pc, dataChannel;

// ===== CRT-STYLE LINE PRINTING =====
async function printLines(lines, options={}) {
    for (const line of lines) {
        log(line, options);
        await new Promise(r => setTimeout(r, Math.random() * 50 + 10));
    }
}

// ===== HOST GAME =====
async function startHost() {
    await enterTerminalMode();
    clearTerminal(term);

    log("Booting WebRTC host...");

    const ascii = await getASCII();
    if (ascii) await printLines(ascii.split("\n"), {highlight:true});

    pc = new RTCPeerConnection();
    dataChannel = pc.createDataChannel("dnd");
    dataChannel.onmessage = e => log("[CLIENT] " + e.data);

    pc.onicecandidate = e => {
        if (e.candidate) log("ICE Candidate: " + JSON.stringify(e.candidate));
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const encoded = btoa(JSON.stringify(offer));
    log("Host ready.");
    await printLines(["=== BASE64 GAME ID ===", encoded, "====================="], {highlight:true});

    showHelp(term, true);
}

// ===== JOIN GAME =====
async function joinGame() {
    await enterTerminalMode();
    clearTerminal(term);

    const gameId = document.getElementById("gameId").value.trim();
    if (!gameId) return log("Enter a game ID first!");

    log("Connecting to host...");

    const ascii = await getASCII();
    if (ascii) await printLines(ascii.split("\n"), {highlight:true});

    const offer = JSON.parse(atob(gameId));
    pc = new RTCPeerConnection();

    pc.ondatachannel = ev => {
        dataChannel = ev.channel;
        dataChannel.onmessage = e => log("[HOST] " + e.data);
    };

    pc.onicecandidate = e => {
        if (e.candidate) log("ICE Candidate: " + JSON.stringify(e.candidate));
    };

    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    log("Connected to host.");
    showHelp(term, false);
}

// ===== BUTTONS =====
document.getElementById("hostBtn").onclick = async () => {
    if (!pyodideReady) return log("Engine not ready.");
    startHost();
};

document.getElementById("joinBtn").onclick = async () => {
    if (!pyodideReady) return log("Engine not ready.");
    joinGame();
};

// ===== CLI INPUT =====
const cmdInput = document.createElement("input");
cmdInput.placeholder = ">";
cmdInput.style.background = "black";
cmdInput.style.color = "#0f0";
cmdInput.style.border = "none";
cmdInput.style.outline = "none";
cmdInput.style.fontFamily = "'VT323', monospace";
cmdInput.style.fontSize = "1.2em";
cmdInput.style.width = "100%";

termContainer.appendChild(cmdInput);
cmdInput.focus();

cmdInput.addEventListener("keydown", async e => {
    if (e.key !== "Enter") return;
    const cmd = cmdInput.value.trim();
    cmdInput.value = "";

    log("> " + cmd);

    if (pyodideReady) {
        try {
            const res = await pyodide.runPythonAsync(cmd);
            if (res !== undefined) log(String(res));
        } catch (err) {
            log("Error: " + err);
        }
    }

    if (dataChannel?.readyState === "open") dataChannel.send(cmd);
});

termContainer.addEventListener("click", () => cmdInput.focus());
</script>
</body>
</html>
